import { Router } from 'express';
import { KomboController } from '../controllers/KomboController.simple';

// –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π KomboController –¥–ª—è –±–∞–∑–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

// Mock automation –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Ä–æ—É—Ç–∞–º–∏
const MockAutomationController = {
  startAutomation: (req: any, res: any) => {
    res.json({ success: true, message: 'Mock automation started' });
  },
  stopAutomation: (req: any, res: any) => {
    res.json({ success: true, message: 'Mock automation stopped' });
  },
  pauseAutomation: (req: any, res: any) => {
    res.json({ success: true, message: 'Mock automation paused' });
  },
  resumeAutomation: (req: any, res: any) => {
    res.json({ success: true, message: 'Mock automation resumed' });
  },
  getAutomationStatus: (req: any, res: any) => {
    res.json({
      success: true,
      data: {
        pupiterStatus: {
          isRunning: false,
          isPaused: false,
          progress: 0,
          activeProfiles: 0,
          totalProfiles: 0
        }
      }
    });
  },
  healthCheck: (req: any, res: any) => {
    res.json({ success: true, data: { overall: 'healthy' } });
  }
};

// –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π KomboController
const AutomationController = MockAutomationController;
import { authenticateToken } from '../middleware/auth';
import { validateKomboCreatePosts, validateKomboUpload } from '../middleware/validation';
import { cacheMiddleware, invalidateCacheMiddleware } from '../middleware/cache';
import multer from 'multer';
import path from 'path';

const router = Router();

// –í—Å–µ —Ä–æ—É—Ç—ã —Ç—Ä–µ–±—É—é—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
router.use(authenticateToken);

// Multer configuration –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, path.join(__dirname, '../../uploads'));
  },
  filename: (req, file, cb) => {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, `kombo-${uniqueSuffix}${path.extname(file.originalname)}`);
  }
});

const upload = multer({
  storage,
  limits: {
    fileSize: 100 * 1024 * 1024, // 100MB
    files: 1
  },
  fileFilter: (req, file, cb) => {
    const allowedTypes = /jpeg|jpg|png|gif|mp4|mov|avi|mkv/;
    const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());
    const mimetype = allowedTypes.test(file.mimetype);

    if (mimetype && extname) {
      return cb(null, true);
    } else {
      cb(new Error('Only image and video files are allowed'));
    }
  }
});

// === –û–°–ù–û–í–ù–´–ï KOMBO ENDPOINTS === //

/**
 * üìã –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –¥–ª—è Kombo
 * GET /kombo/accounts
 */
router.get('/accounts',
  cacheMiddleware(30),
  KomboController.getAccounts
);

/**
 * üìÇ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ Dropbox –ø–∞–ø–∫–∏
 * GET /kombo/dropbox/folder
 */
router.get('/dropbox/folder',
  cacheMiddleware(60),
  KomboController.getDropboxContent
);

/**
 * üìÇ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Dropbox –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
 * GET /kombo/dropbox/status
 */
router.get('/dropbox/status',
  cacheMiddleware(30),
  KomboController.getDropboxStatus
);

/**
 * üìù –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ –∏–∑ Kombo –¥–∞–Ω–Ω—ã—Ö
 * POST /kombo/create-posts
 */
router.post('/create-posts',
  validateKomboCreatePosts,
  invalidateCacheMiddleware('posts-.*', 'dashboard-.*'),
  KomboController.createPosts
);

/**
 * üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞ —Ñ–∞–π–ª–∞
 * POST /kombo/upload
 */
router.post('/upload',
  upload.single('media'),
  validateKomboUpload,
  invalidateCacheMiddleware('posts-.*'),
  KomboController.uploadMedia
);

// === PUPITER AUTOMATION ENDPOINTS === //
// –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ endpoints –¥–ª—è KomboNew Pupiter –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

/**
 * üéÆ –ó–∞–ø—É—Å–∫ Pupiter –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
 * POST /kombo/pupiter/start
 */
router.post('/pupiter/start', async (req, res, next) => {
  try {
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è AutomationController
    const { selectedAccounts, settings } = req.body;
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º selectedAccounts –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è AutomationController
    req.body = {
      accountIds: selectedAccounts || [],
      settings: {
        maxConcurrentAccounts: settings?.maxConcurrentAccounts || 3,
        delayBetweenPosts: settings?.delayBetweenPosts || { min: 1800, max: 3600 },
        workingHours: settings?.workingHours || { start: 9, end: 21 },
        respectInstagramLimits: true,
        ...settings
      }
    };

    // –î–µ–ª–µ–≥–∏—Ä—É–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ AutomationController
    return AutomationController.startAutomation(req, res);
  } catch (error: any) {
    res.status(500).json({
      success: false,
      error: error.message || 'Failed to start Pupiter automation'
    });
  }
});

/**
 * üéÆ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Pupiter –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
 * POST /kombo/pupiter/stop
 */
router.post('/pupiter/stop', async (req, res) => {
  try {
    const { selectedAccounts } = req.body;
    
    req.body = {
      accountIds: selectedAccounts || undefined,
      force: req.body.force || false
    };

    return AutomationController.stopAutomation(req, res);
  } catch (error: any) {
    res.status(500).json({
      success: false,
      error: error.message || 'Failed to stop Pupiter automation'
    });
  }
});

/**
 * üéÆ –ü–∞—É–∑–∞ Pupiter –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
 * POST /kombo/pupiter/pause
 */
router.post('/pupiter/pause', AutomationController.pauseAutomation);

/**
 * üéÆ –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Pupiter –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
 * POST /kombo/pupiter/resume
 */
router.post('/pupiter/resume', AutomationController.resumeAutomation);

/**
 * üéÆ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Pupiter –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
 * POST /kombo/pupiter/restart
 */
router.post('/pupiter/restart', async (req, res) => {
  try {
    const userId = (req as any).user?.userId;
    
    // –°–Ω–∞—á–∞–ª–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
    const stopBody = { ...req.body, force: false };
    req.body = stopBody;
    
    // –°–∏–º—É–ª–∏—Ä—É–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É
    await new Promise((resolve) => {
      AutomationController.stopAutomation(req, {
        json: () => resolve(null),
        status: () => ({ json: () => resolve(null) })
      } as any);
    });

    // –ñ–¥–µ–º 2 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è graceful shutdown
    setTimeout(async () => {
      try {
        // –ó–∞—Ç–µ–º –∑–∞–ø—É—Å–∫–∞–µ–º –∑–∞–Ω–æ–≤–æ
        const { selectedAccounts, settings } = req.body;
        req.body = {
          accountIds: selectedAccounts || [],
          settings: settings || {}
        };

        return AutomationController.startAutomation(req, res);
      } catch (error: any) {
        res.status(500).json({
          success: false,
          error: error.message || 'Failed to restart automation'
        });
      }
    }, 2000);

  } catch (error: any) {
    res.status(500).json({
      success: false,
      error: error.message || 'Failed to restart Pupiter automation'
    });
  }
});

/**
 * üéÆ –°—Ç–∞—Ç—É—Å Pupiter –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –¥–ª—è KomboNew
 * GET /kombo/pupiter/status
 */
router.get('/pupiter/status',
  cacheMiddleware(5), // –ö—ç—à–∏—Ä—É–µ–º –Ω–∞ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è real-time updates
  async (req, res) => {
    try {
      // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç AutomationController
      const originalSend = res.json;
      let statusData: any = null;

      res.json = function(data: any) {
        statusData = data;
        return this;
      };

      await AutomationController.getAutomationStatus(req, res);

      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è KomboNew
      if (statusData?.success && statusData?.data) {
        const { automation, userStats, systemHealth } = statusData.data;
        
        const pupiterStatus = {
          isRunning: automation.isRunning,
          isPaused: automation.isPaused,
          currentTask: automation.currentTask || '–û–∂–∏–¥–∞–Ω–∏–µ...',
          progress: Math.round((automation.completedToday / Math.max(userStats.scheduledPosts, 1)) * 100),
          activeProfiles: userStats.activeAccounts,
          totalProfiles: userStats.totalAccounts,
          postsCompleted: automation.completedToday,
          postsInQueue: automation.tasksInQueue,
          errors: automation.failedToday,
          uptime: automation.uptime,
          lastActivity: automation.lastActivity
        };

        res.json = originalSend;
        return res.json({
          success: true,
          data: {
            pupiterStatus,
            systemHealth: systemHealth.overall,
            timestamp: new Date().toISOString()
          }
        });
      } else {
        res.json = originalSend;
        return res.status(500).json({
          success: false,
          error: 'Failed to get Pupiter status'
        });
      }

    } catch (error: any) {
      res.status(500).json({
        success: false,
        error: error.message || 'Failed to get Pupiter status'
      });
    }
  }
);

/**
 * üéÆ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Pupiter —Å–∏—Å—Ç–µ–º—ã
 * GET /kombo/pupiter/diagnostics
 */
router.get('/pupiter/diagnostics',
  cacheMiddleware(30),
  async (req, res) => {
    try {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º health check –æ—Ç AutomationController
      const originalSend = res.json;
      let healthData: any = null;

      res.json = function(data: any) {
        healthData = data;
        return this;
      };

      await AutomationController.healthCheck(req, res);

      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –¥–ª—è KomboNew
      if (healthData?.success) {
        const diagnostics = {
          overall: healthData.data.status,
          services: healthData.data.services,
          automation: healthData.data.automation,
          circuitBreakers: healthData.data.circuitBreakers,
          recommendations: [],
          timestamp: new Date().toISOString()
        };

        // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞
        if (healthData.data.status !== 'healthy') {
          diagnostics.recommendations.push('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ AdsPower');
          diagnostics.recommendations.push('–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã');
        }

        res.json = originalSend;
        return res.json({
          success: true,
          data: diagnostics
        });
      } else {
        res.json = originalSend;
        return res.status(503).json({
          success: false,
          error: 'Diagnostics failed',
          data: {
            overall: 'error',
            timestamp: new Date().toISOString()
          }
        });
      }

    } catch (error: any) {
      res.status(500).json({
        success: false,
        error: error.message || 'Diagnostics failed'
      });
    }
  }
);

// === LEGACY SUPPORT === //

/**
 * üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Kombo (legacy)
 * GET /kombo/stats
 */
router.get('/stats',
  cacheMiddleware(60),
  async (req, res) => {
    try {
      // –ü—Ä–æ—Å—Ç–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è backward compatibility
      res.json({
        success: true,
        data: {
          totalAccounts: 0,
          activeAccounts: 0,
          totalPosts: 0,
          publishedToday: 0,
          timestamp: new Date().toISOString()
        }
      });
    } catch (error: any) {
      res.status(500).json({
        success: false,
        error: error.message || 'Failed to get stats'
      });
    }
  }
);

// === ERROR HANDLING === //

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö kombo endpoints
router.use('*', (req, res) => {
  res.status(404).json({
    success: false,
    error: `Kombo endpoint not found: ${req.method} ${req.originalUrl}`,
    availableEndpoints: {
      accounts: 'GET /kombo/accounts',
      dropbox: {
        folder: 'GET /kombo/dropbox/folder',
        status: 'GET /kombo/dropbox/status'
      },
      posts: {
        create: 'POST /kombo/create-posts',
        upload: 'POST /kombo/upload'
      },
      pupiter: {
        start: 'POST /kombo/pupiter/start',
        stop: 'POST /kombo/pupiter/stop',
        pause: 'POST /kombo/pupiter/pause',
        resume: 'POST /kombo/pupiter/resume',
        restart: 'POST /kombo/pupiter/restart',
        status: 'GET /kombo/pupiter/status',
        diagnostics: 'GET /kombo/pupiter/diagnostics'
      }
    }
  });
});

export default router; 